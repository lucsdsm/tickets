{% extends "layout.html" %}

{% block content %}
<fieldset class="w-full h-full flex flex-col space-y-4 bg-gray-50 dark:bg-gray-900 p-8 rounded-lg">
    
    <!-- blocos focados no usu치rio atual -->
    <div class="grid grid-cols-1 md:grid-cols-1 gap-8 mb-2">

        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md flex items-center space-x-4">
 
            <div class="bg-blue-100 dark:bg-blue-900 p-3 rounded-full">
                <svg class="w-6 h-6 text-gray-500 dark:text-gray-400 group-hover:text-purple-600 dark:group-hover:text-purple-400 transition-colors duration-200"
                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <circle cx="12" cy="6" r="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M12 8v3" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M12 11H7" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M12 11h5" stroke-linecap="round" stroke-linejoin="round" />
                    <circle cx="7" cy="17" r="2" stroke-linecap="round" stroke-linejoin="round" />
                    <circle cx="17" cy="17" r="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </div>

            <div>
                <p class="text-sm text-gray-500 dark:text-gray-400"> Chamados abertos atribu칤dos ao(s) meu setor(es) </p>
                <p class="text-2xl font-bold dark:text-white"> {{ sector_user_tickets_count }} </p>
            </div>
        </div> 
    </div>

    <!-- tabela de tickets do usu치rio -->

    <!-- tabela de tickets abertos no setor do usu치rio -->
    <div class="custom-scrollbar flex-col flex-row justify-between items-center overflow-auto bg-white dark:bg-gray-800 p-8 rounded-lg shadow-md">
        <!-- cabe칞alho -->
        <div class="flex flex-col md:flex-row items-center md:items-center gap-4 w-full md:w-auto mt-4 md:mt-0">
            <div class="flex w-full w-auto items-center gap-4 justify-between">
                <legend class="text-2xl pb-2 border-b font-bold dark:text-white">
                    <!-- Verifica se a lista de setores do utilizador n칚o est치 vazia -->
                    {% if current_user.sectors %}
                    Tickets do(a)
                    <!-- Percorre cada setor na lista -->
                    {% for sector in current_user.sectors %}
                    <span style="background-color: {{ sector.color }}" class="align-middle text-white text-xs font-medium px-2.5 py-0.5 rounded-full">
                        {{ sector.name }}
                    </span>{% if not loop.last %}, {% endif %}
                    {% endfor %}
                    {% else %}
                    <!-- Mensagem para o caso de o utilizador n칚o ter setores -->
                    Nenhum setor atribu칤do
                    {% endif %}
                </legend>

            </div>
        </div>
        
        <!-- tabela para desktop -->
        <div class="hidden md:block mt-4">
            <table class="w-full font-thin dark:text-gray-400 text-center border-separate border-spacing-y-1">
                <thead class="uppercase text-gray-700 dark:text-gray-400">
                    <tr>
                        <th scope="col" class="px-6 py-3">
                            <a href="{{ url_for('dashboard.user_tickets', sort_by='id', direction='desc' if sort_by == 'id' and direction == 'asc' else 'asc') }}"
                                class="flex justify-center items-center hover:text-purple-500 transition-colors dark:text-white dark:hover:text-purple-500">
                        
                                ID
                        
                                {% if sort_by == 'id' %}
                                    {% if direction == 'asc' %}
                                        <svg class="w-5 h-5 ml-1 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                        </svg>
                                    {% else %}
                                        <svg class="w-5 h-5 ml-1 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    {% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th scope="col" class="px-6 py-3">
                            <a href="{{ url_for('dashboard.user_tickets', sort_by='title', direction='desc' if sort_by == 'title' and direction == 'asc' else 'asc') }}"
                                class="flex justify-center items-center hover:text-purple-500 transition-colors dark:text-white dark:hover:text-purple-500">
                                T칤tulo
                                {% if sort_by == 'title' %}
                                    {% if direction == 'asc' %}
                                        <svg class="w-5 h-5 ml-1 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                        </svg>
                                    {% else %}
                                        <svg class="w-5 h-5 ml-1 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    {% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th scope="col" class="px-6 py-3">
                            <a href="{{ url_for('dashboard.user_tickets', sort_by='sector', direction='desc' if sort_by == 'sector' and direction == 'asc' else 'asc') }}"
                                class="flex justify-center items-center hover:text-purple-500 transition-colors dark:text-white dark:hover:text-purple-500">

                                Setor

                                {% if sort_by == 'sector' %}
                                    {% if direction == 'asc' %}
                                        <svg class="w-5 h-5 ml-1 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                        </svg>
                                    {% else %}
                                        <svg class="w-5 h-5 ml-1 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    {% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th scope="col" class="px-6 py-3">
                            <a href="{{ url_for('dashboard.user_tickets', sort_by='subject', direction='desc' if sort_by == 'subject' and direction == 'asc' else 'asc') }}"
                                class="flex justify-center items-center hover:text-purple-500 transition-colors dark:text-white dark:hover:text-purple-500">
                        
                                Assunto
                        
                                {% if sort_by == 'subject' %}
                                    {% if direction == 'asc' %}
                                        <svg class="w-5 h-5 ml-1 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                        </svg>
                                        {% else %}
                                        <svg class="w-5 h-5 ml-1 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    {% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th scope="col" class="px-6 py-3">
                            <a href="{{ url_for('dashboard.user_tickets', sort_by='creator', direction='desc' if sort_by == 'creator' and direction == 'asc' else 'asc') }}"
                                class="flex justify-center items-center hover:text-purple-500 transition-colors dark:text-white dark:hover:text-purple-500">

                                Criado por

                                {% if sort_by == 'creator' %}
                                    {% if direction == 'asc' %}
                                        <svg class="w-5 h-5 ml-1 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                        </svg>
                                    {% else %}
                                        <svg class="w-5 h-5 ml-1 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    {% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th scope="col" class="px-6 py-3">
                            <a href="{{ url_for('dashboard.user_tickets', sort_by='created_at', direction='desc' if sort_by == 'created_at' and direction == 'asc' else 'asc') }}"
                                class="flex justify-center items-center hover:text-purple-500 transition-colors dark:text-white dark:hover:text-purple-500">
                                
                                Criado em

                                {% if sort_by == 'created_at' %}
                                    {% if direction == 'asc' %}
                                        <svg class="w-5 h-5 ml-1 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                        </svg>
                                    {% else %}
                                        <svg class="w-5 h-5 ml-1 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    {% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th scope="col" class="px-6 py-3">
                            <a href="{{ url_for('dashboard.user_tickets', sort_by='status', direction='desc' if sort_by == 'status' and direction == 'asc' else 'asc') }}"
                                class="flex justify-center items-center hover:text-purple-500 transition-colors dark:text-white dark:hover:text-purple-500">
                                Status
                                {% if sort_by == 'status' %}
                                    {% if direction == 'asc' %}
                                        <svg class="w-5 h-5 ml-1 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                                        </svg>
                                    {% else %}
                                        <svg class="w-5 h-5 ml-1 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    {% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th scope="col" class="w-1/12 px-6 py-3 text-center transition-colors dark:text-white"> A칞칫es </th>
                    </tr>
                </thead>
        
                <tbody x-data="{ editId: null }">
                    {% for ticket in sector_user_tickets %}
                    <tr class="dark:border-gray-700 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors">
                        <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white text-center"
                            style="border-left: 3px solid {{ ticket.priority.color }};">
                            {{ ticket.id }}
                        </td>
        
                        <td
                            class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white first:rounded-l-lg last:rounded-r-lg text-center">
                            {{ ticket.title }}
                        </td>
        
                        <td class="px-6 py-4 font-normal whitespace-nowrap dark:text-white">
                            <!-- modo de visualiza칞칚o dos setores no desktop -->
                            <div x-show="editId !== {{ ticket.id }}" class="flex flex-wrap gap-1 justify-center">
                                {% if ticket.sector %}
                                <span style="background-color: {{ ticket.sector.color }}"
                                    class="text-white text-xs font-medium px-2.5 py-0.5 rounded-full">
                                    {{ ticket.sector.name }}
                                </span>
                                {% else %}
                                <span class=" text-center"> Nenhum </span>
                                {% endif %}
                            </div>
                        </td>
        
                        <td
                            class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white first:rounded-l-lg last:rounded-r-lg text-center">
                            {{ ticket.subject.name }}
                        </td>
        
                        <td
                            class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white first:rounded-l-lg last:rounded-r-lg text-center">
                            {{ ticket.creator.first_name }} {{ ticket.creator.last_name }}
                        </td>

                        <td x-data="{ localTime: '' }" x-init="
                                localTime = new Date($el.dataset.utc + 'Z').toLocaleString('pt-BR', {
                                    day: '2-digit',
                                    month: '2-digit',
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    hour12: false
                                }).replace(',', ' 맙')
                            " x-text="localTime" data-utc="{{ ticket.created_at.isoformat() }}"
                            class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white first:rounded-l-lg last:rounded-r-lg text-center">
                        </td>

                        <td
                            class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white first:rounded-l-lg last:rounded-r-lg text-center">
                            {{ ticket.status.name }}
                        </td>

                        <td class="px-6 py-4 first:rounded-l-lg last:rounded-r-lg">
                            <div class="flex items-center justify-center space-x-3">
                                <!-- detalhe do chamado -->
                                <a href="{{ url_for('tickets.view_ticket', ticket_id=ticket.id) }}" class="text-gray-600 dark:text-gray-400 hover:opacity-75" title="Ver Detalhes">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z">
                                        </path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z">
                                        </path>
                                    </svg>
                                </a>

                                <!-- atribuir chamado -->
                                <button
                                    @click="$dispatch('open-confirm', { 
                                        message: 'Tem certeza que deseja assumir este ticket?', 
                                        url: '{{ url_for('tickets.assign_ticket', ticket_id=ticket.id) }}' 
                                    })"
                                    class="py-1 text-white rounded-md text-sm ">
                                    <a class="text-gray-600 dark:text-gray-400 hover:opacity-75" title="Atribuir chamado">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"
                                            class="w-5 h-5">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M10.05 4.575a1.575 1.575 0 1 0-3.15 0v3m3.15-3v-1.5a1.575 1.575 0 0 1 3.15 0v1.5m-3.15 0 .075 5.925m3.075.75V4.575m0 0a1.575 1.575 0 0 1 3.15 0V15M6.9 7.575a1.575 1.575 0 1 0-3.15 0v8.175a6.75 6.75 0 0 0 6.75 6.75h2.018a5.25 5.25 0 0 0 3.712-1.538l1.732-1.732a5.25 5.25 0 0 0 1.538-3.712l.003-2.024a.668.668 0 0 1 .198-.471 1.575 1.575 0 1 0-2.228-2.228 3.818 3.818 0 0 0-1.12 2.687M6.9 7.575V12m6.27 4.318A4.49 4.49 0 0 1 16.35 15m.002 0h-.002" />
                                        </svg>
                                    </a>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center py-4"> Nenhum ticket atribu칤do ao seu setor, ainda 游때. </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</fieldset>
{% endblock %}

