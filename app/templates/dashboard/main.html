{% extends "layout.html" %}

{% block content %}
<fieldset class="w-full h-full flex flex-col space-y-4 bg-gray-50 dark:bg-gray-900 p-8 rounded-lg">
    
    <!-- blocos focados no usuário atual -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-4">

        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md flex items-center">

            <div class="bg-green-100 dark:bg-green-900 p-3 rounded-full space-x-4">
                <svg class="w-6 h-6 text-green-600 dark:text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m3.75 9v6m3-3H9m1.5-12H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                </svg>
            </div>

            <div class="space-x-4">
                <p class="text-sm text-gray-500 dark:text-gray-400 ml-4"> Chamados abertos por mim </p>
                <p class="text-2xl font-bold dark:text-white ml-4"> {{ open_user_tickets_count }} </p>
            </div>

            <a href="{{ url_for('tickets.add') }}" title="Criar novo ticket"
                class="ml-auto flex-shrink-0 inline-flex items-center justify-center w-10 h-10 text-white bg-purple-600 border border-transparent rounded-full shadow-sm hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 dark:focus:ring-offset-gray-800">
                <span class="sr-only"> Criar ticket </span>
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
            </a>
        </div>

        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md flex items-center space-x-4">

            <div class="bg-purple-100 dark:bg-purple-900 p-3 rounded-full">
                <svg class="w-6 h-6 text-purple-600 dark:text-purple-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                </svg>
            </div>

            <div>
                <p class="text-sm text-gray-500 dark:text-gray-400"> Chamados para mim </p>
                <p class="text-2xl font-bold dark:text-white"> {{ assigned_user_tickets_count }} </p>
            </div>
        </div>


        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md flex items-center space-x-4">
 
            <div class="bg-blue-100 dark:bg-blue-900 p-3 rounded-full">
                <svg class="w-6 h-6 text-gray-500 dark:text-gray-400 group-hover:text-purple-600 dark:group-hover:text-purple-400 transition-colors duration-200"
                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <circle cx="12" cy="6" r="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M12 8v3" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M12 11H7" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M12 11h5" stroke-linecap="round" stroke-linejoin="round" />
                    <circle cx="7" cy="17" r="2" stroke-linecap="round" stroke-linejoin="round" />
                    <circle cx="17" cy="17" r="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </div>

            <div>
                <p class="text-sm text-gray-500 dark:text-gray-400"> Chamados abertos atribuídos ao(s) meu setor(es) </p>
                <p class="text-2xl font-bold dark:text-white"> {{ sector_user_tickets_count }} </p>
            </div>
        </div> 
    </div>

    <!-- tabela de tickets abertos no setor do usuário -->
    <div class="custom-scrollbar flex-col flex-row justify-between items-center overflow-auto bg-white dark:bg-gray-800 p-8 rounded-lg shadow-md">
        <!-- cabeçalho -->
        <div class="flex flex-col md:flex-row items-center md:items-center gap-4 w-full md:w-auto mt-4 md:mt-0">
            <div class="flex w-full w-auto items-center gap-4 justify-between">
                <legend class="text-2xl pb-2 border-b font-bold dark:text-white">
                    Tickets do(a)
            
                    <!-- Verifica se a lista de setores do utilizador não está vazia -->
                    {% if current_user.sectors %}
                    <!-- Percorre cada setor na lista -->
                    {% for sector in current_user.sectors %}
                    <span style="background-color: {{ sector.color }}" class="align-middle text-white text-xs font-medium px-2.5 py-0.5 rounded-full">
                        {{ sector.name }}
                    </span>{% if not loop.last %}, {% endif %}
                    {% endfor %}
                    {% else %}
                    <!-- Mensagem para o caso de o utilizador não ter setores -->
                    Nenhum setor atribuído
                    {% endif %}
                </legend>

            </div>
        </div>
        
        <!-- tabela para desktop -->
        <div class="hidden md:block mt-4">
            <table class="w-full font-thin dark:text-gray-400 text-center border-separate border-spacing-y-1">
                <thead class="uppercase text-gray-700 dark:text-gray-400">
                    <tr>
                        <th scope="col" class="px-6 py-3">
                            <a href="#"
                                class="flex justify-center items-center hover:text-purple-500 transition-colors dark:text-white dark:hover:text-purple-500">
                                ID
                                {% if sort_by == 'id' %}
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path>
        
                                    {% if direction == 'asc' %}
                                    <path d="M5 15l7-7 7 7" />{% else %}
                                    <path d="M19 9l-7 7-7-7" />{% endif %}
                                </svg>
                                {% endif %}
                            </a>
                        </th>
                        <th scope="col" class="px-6 py-3">
                            <a href="#"
                                class="flex justify-center items-center hover:text-purple-500 transition-colors dark:text-white dark:hover:text-purple-500">
                                Título
                                {% if sort_by == 'title' %}
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path>
        
                                    {% if direction == 'asc' %}
                                    <path d="M5 15l7-7 7 7" />{% else %}
                                    <path d="M19 9l-7 7-7-7" />{% endif %}
                                </svg>
                                {% endif %}
                            </a>
                        </th>
                        <th scope="col" class="px-6 py-3">
                            <a href="#"
                                class="flex justify-center items-center hover:text-purple-500 transition-colors dark:text-white dark:hover:text-purple-500">
                                Setor
                                {% if sort_by == 'sector_id' %}
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path>
        
                                    {% if direction == 'asc' %}
                                    <path d="M5 15l7-7 7 7" />{% else %}
                                    <path d="M19 9l-7 7-7-7" />{% endif %}
                                </svg>
                                {% endif %}
                            </a>
                        </th>
                        <th scope="col" class="px-6 py-3">
                            <a href="#"
                                class="flex justify-center items-center hover:text-purple-500 transition-colors dark:text-white dark:hover:text-purple-500">
                                Assunto
                                {% if sort_by == 'subject_id' %}
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path>
        
                                    {% if direction == 'asc' %}
                                    <path d="M5 15l7-7 7 7" />{% else %}
                                    <path d="M19 9l-7 7-7-7" />{% endif %}
                                </svg>
                                {% endif %}
                            </a>
                        </th>
                        <th scope="col" class="px-6 py-3">
                            <a href="#"
                                class="flex justify-center items-center hover:text-purple-500 transition-colors dark:text-white dark:hover:text-purple-500">
                                Criado por
                                {% if sort_by == 'creator_id' %}
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path>
        
                                    {% if direction == 'asc' %}
                                    <path d="M5 15l7-7 7 7" />{% else %}
                                    <path d="M19 9l-7 7-7-7" />{% endif %}
                                </svg>
                                {% endif %}
                            </a>
                        </th>
                        <th scope="col" class="px-6 py-3">
                            <a href="#"
                                class="flex justify-center items-center hover:text-purple-500 transition-colors dark:text-white dark:hover:text-purple-500">
                                Criado em
                                {% if sort_by == 'created_at' %}
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path>
        
                                    {% if direction == 'asc' %}
                                    <path d="M5 15l7-7 7 7" />{% else %}
                                    <path d="M19 9l-7 7-7-7" />{% endif %}
                                </svg>
                                {% endif %}
                            </a>
                        </th>
                        <th scope="col" class="px-6 py-3">
                            <a href="#"
                                class="flex justify-center items-center hover:text-purple-500 transition-colors dark:text-white dark:hover:text-purple-500">
                                Status
                                {% if sort_by == 'status' %}
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path>
        
                                    {% if direction == 'asc' %}
                                    <path d="M5 15l7-7 7 7" />{% else %}
                                    <path d="M19 9l-7 7-7-7" />{% endif %}
                                </svg>
                                {% endif %}
                            </a>
                        </th>
                        <th scope="col" class="w-1/12 px-6 py-3 text-center transition-colors dark:text-white"> Ações </th>
                    </tr>
                </thead>
        
                <tbody x-data="{ editId: null }">
                    {% for ticket in tickets_on_sector %}
                    <tr class="dark:border-gray-700 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors">
                        <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white text-center"
                            style="border-left: 3px solid {{ ticket.priority.color }};">
                            {{ ticket.id }}
                        </td>
        
                        <td
                            class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white first:rounded-l-lg last:rounded-r-lg text-center">
                            {{ ticket.title }}
                        </td>
        
                        <td class="px-6 py-4 font-normal whitespace-nowrap dark:text-white">
                            <!-- modo de visualização dos setores no desktop -->
                            <div x-show="editId !== {{ ticket.id }}" class="flex flex-wrap gap-1 justify-center">
                                {% if ticket.sector %}
                                <span style="background-color: {{ ticket.sector.color }}"
                                    class="text-white text-xs font-medium px-2.5 py-0.5 rounded-full">
                                    {{ ticket.sector.name }}
                                </span>
                                {% else %}
                                <span class=" text-center"> Nenhum </span>
                                {% endif %}
                            </div>
                        </td>
        
                        <td
                            class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white first:rounded-l-lg last:rounded-r-lg text-center">
                            {{ ticket.subject.name }}
                        </td>
        
                        <td
                            class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white first:rounded-l-lg last:rounded-r-lg text-center">
                            {{ ticket.creator.first_name }} {{ ticket.creator.last_name }}
                        </td>

                        <td x-data="{ localTime: '' }" x-init="
                                localTime = new Date($el.dataset.utc + 'Z').toLocaleString('pt-BR', {
                                    day: '2-digit',
                                    month: '2-digit',
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    hour12: false
                                }).replace(',', ' às')
                            " x-text="localTime" data-utc="{{ ticket.created_at.isoformat() }}"
                            class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white first:rounded-l-lg last:rounded-r-lg text-center">
                        </td>

                        <td
                            class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white first:rounded-l-lg last:rounded-r-lg text-center">
                            {{ ticket.status.name }}
                        </td>

                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center py-4"> Nenhum ticket atribuído a você, ainda 😁. </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
</fieldset>
{% endblock %}

